---
title: "p8105_hw3_WL3011"
author: "Weiqi Liang"
date: "`r Sys.Date()`"
output: github_document
always_allow_html: true
---

## Setup File
```{r setup, message = FALSE, results='hide'}
library(tidyverse)
library(dplyr)
library(knitr)
library(kableExtra)
library(ggplot2)
library(patchwork) 
```

## Problem 1
Firstly load the data.
```{r}
library(p8105.datasets)
data("ny_noaa")
```
Dataset **NY NOAA** has `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns, showing a list of all GHCND-Daily weather stations in New York state with weather data, respectively. The variables include:

*   `id`: Weather station ID
*   `date`: Date of observation
*   `prcp`: Precipitation ($10^{-1}$ mm)
*   `snow`: The amount of snowfall (mm)
*   `snwd`: Snow depth (mm)
*   `tmax`: Maximum temperature ($10^{-1}$ &deg;C)
*   `tmin`: Minimum temperature ($10^{-1}$ &deg;C)

### 1.1 Data Cleaning

*   Create separate variables for year, month, and day.
*   Convert `prcp`, `tmax`, `tmin` to standard units, i.e., mm and degree  Celsius, respectively.

```{r}
# basic dataset: ny_noaa
ny_noaa = ny_noaa |>

  mutate(
    year = format(pull(ny_noaa, date), "%Y"),
    month = format(pull(ny_noaa, date), "%m"),
    day = format(pull(ny_noaa, date), "%d")
    ) |>
  relocate(id, date, year, month, day) |> 
  mutate(
    across(-c(date, id), as.numeric),
    prcp = prcp / 10,     
    tmax = tmax / 10,     
    tmin = tmin / 10      
  )

```

```{r SNOW, fig.cap="Figure 1. Frequency of Zero and Non-Zero Snowfall(mm) by Month"}
snowfall_frequency = ny_noaa |>
  count(snow, sort = TRUE)  # sort = TRUE means descending
head(snowfall_frequency)

snowfall_df = ny_noaa |>
  filter(!is.na(snow)) |>
  mutate(snowfall_category = ifelse(snow == 0, "Zero", "Non-Zero")) |>
  count(month, snowfall_category)

# bar plot
ggplot(snowfall_df, aes(x = month, y = n, fill = snowfall_category)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Month", 
    y = "Frequency"
    ) +
  scale_fill_manual(
    name = "Snowfall (mm)", 
    values = c("Zero" = "orange", "Non-Zero" = "skyblue")
    ) +
  scale_x_continuous(breaks = 1:12) + 
  theme_minimal()
```

*   For `snow`, the most commonly observed values is **0**. from the figure above, it is obvious that the number of snowy days is far fewer than the number of non-snowy days. Therefore, the most observed amount of snowfall is 0.


### 1.2 Average Max Temperature

Plot below shows the average max temperature in January and in July in each station across years. 

```{r AMT, fig.cap="Figure 2. Average Max Temperature in January and July Across Years"}
# each stations' average max temperature in January & July 
avg_tmax_df = ny_noaa |> 
  filter(month == 1 | month == 7) |>
  group_by(id, month, year) |>
  mutate(
    avg_tmax = mean(tmax, na.rm = TRUE)
    ) |>
  ungroup() |>
  distinct(id, year, month, avg_tmax) |>
  pivot_wider(
    names_from = month, 
    values_from = avg_tmax,
    names_prefix = "month_"
  )

# Create separate plots for January and July

# Plot for January
p_january = ggplot(avg_tmax_df, aes(x = year)) +
  geom_line(aes(y = month_1, color = id, group = id), size = .1) +
  geom_point(aes(y = month_1, color = id), size = .2) +
  labs(
    x = "Year", 
    y = "Average Max Temperature (°C)", 
    color = "Month",
    title = "January"
    ) +
  guides(color = "none") +
  theme_minimal()
  scale_color_discrete() 

# Plot for July
p_july = ggplot(avg_tmax_df, aes(x = year)) +
  geom_line(aes(y = month_7, color = id, group = id), size = .1) +
  geom_point(aes(y = month_7, color = id), size = .2) +
  labs(
    x = "Year", 
    y = "Average Max Temperature (°C)", 
    color = "Month",
    title = "July"
    ) +
  guides(color = "none") +
  theme_minimal() +
  scale_color_discrete() 

# Combine
p_january + p_july

```

Figure 2 above shows a few patterns and observations stand out:

*   Seasonal Variation:

July consistently shows much higher average maximum temperatures (20 to 30°C) compared to January (-10 to 10°C). This reflects the typical seasonal difference between winter and summer.

*   Parallel Trends Across Stations

The year-to-year January and July maximum temperatures recorded at each weather station maintain a parallel pattern, i.e., they have a similar trend of change.

*   Outliers:

There are a few sharp drops (e.g., July showing one or two sudden drops below 20°C and January dipping below -10°C). These might indicate unusual weather events.

*   Noise in January Data:

Compared to the July data, the January data fluctuated more between 1981 and 2010 and had discrete extremes at some stations in 2004. This could indicate that January weather is more unpredictable, perhaps due to snow, storms, or varying cold fronts.






### 1.3 Tmax vs Tmin


Make a two-panel plot showing  (note that a scatterplot may not be the best option); 

```{r MAXMIN, fig.cap="Figure 3. Density Plot of Maximum and Minimum Temperature"}

p_tmax = ggplot(ny_noaa, aes(x = tmax)) +
  geom_density(fill = "orange", alpha = 0.5) +
  labs(title = "Maximum Temperature",
       x = "Maximum Temperature (°C)",
       y = "Density") +
  theme_minimal()

p_tmin = ggplot(ny_noaa, aes(x = tmin)) +
  geom_density(fill = "skyblue", alpha = 0.5) +
  labs(title = "Minimum Temperature",
       x = "Minimum Temperature (°C)",
       y = "Density") +
  theme_minimal()

# Combine 
p_tmin + p_tmax

```


### 1.4 Distribution of Snowfall

(ii) make a plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year.

```{r fig.width = 7, fig.height = 14, fig.cap="Figure 4. Distribution of Snowfall Values"}
p2 = ny_noaa |>
  filter(snow > 0 & snow < 100) |>
  ggplot(aes(x = snow, fill = factor(year))) +
  geom_histogram(position = "dodge", bins = 10) +  
  labs(
    x = "Snowfall (mm)",
    y = "Frequency",
    fill = "Year"
  ) +
  theme_minimal() +
  theme(legend.position = "none") + 
  facet_wrap(~ year, nrow = 6, ncol = 5) 

print(p2)
```


## II. Problem 2

### 2.1 Load and Organize Datasets

*   Include all originally observed variables;  
*   Exclude participants less than 21 years of age;
*   Exclude participants with missing demographic data;  
*   Encode data with reasonable variable classes (i.e. not numeric, and using factors with the ordering of tables and plots in mind).

```{r}
accel_df = 
  read.csv("./nhanes_accel.csv", 
           na = c("NA", ".", "")) |>
  janitor::clean_names() 

covar_df = 
  read.csv("./nhanes_covar.csv", 
           na = c("NA", ".", ""), skip = 4) |>
  janitor::clean_names() 

nhanes_df = 
  inner_join(covar_df, accel_df, by = "seqn") |>
  filter(age >= 21) |>
  drop_na() |>
  mutate(          
    sex = case_match(
      sex,
      1 ~ "male",
      2 ~ "female" 
    )
  ) |>
  mutate(
    education = case_match(
      education,
      1 ~ "Less_than_high_school",
      2 ~ "High_school_equivalent",
      3  ~ "More_than_high_school"
    )
  )

```


## III. Problem 3


